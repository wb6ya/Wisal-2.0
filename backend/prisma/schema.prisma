// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
// ==========================================

model Tenant {
  id                      String             @id @default(uuid())
  name                    String
  email                   String             @unique
  plan                    PlanType           @default(STARTER)
  subscriptionStatus      SubscriptionStatus @default(ACTIVE)
  subscriptionEndsAt      DateTime?
  maxAgents               Int                @default(2)
  baseStorageLimitMB      Int                @default(1000)
  extraStoragePurchasedMB Int                @default(0)
  mediaRetentionDays      Int                @default(60)
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt

  users         User[]
  contacts      Contact[]
  flows         Flow[]
  conversations Conversation[]
  addons        SubscriptionAddon[]
}

model SubscriptionAddon {
  id       String    @id @default(uuid())
  type     AddonType
  quantity Int
  cost     Float
  active   Boolean   @default(true)
  tenantId String
  tenant   Tenant    @relation(fields: [tenantId], references: [id])
}

// ==========================================
// 2. Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
// ==========================================

model User {
  id                    String         @id @default(uuid())
  email                 String         @unique
  password              String
  name                  String
  role                  Role           @default(AGENT)
  isActive              Boolean        @default(true)
  tenantId              String
  tenant                Tenant         @relation(fields: [tenantId], references: [id])
  assignedConversations Conversation[]
}

// ==========================================
// 3. Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù‚Ù†ÙˆØ§Øª (Omnichannel)
// ==========================================

model Contact {
  id        String   @id @default(uuid())
  
  name      String?
  phone     String?
  email     String?
  avatarUrl String?
  tags      String[]
  metadata  Json?

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  // ğŸ‘‡ğŸ‘‡ğŸ‘‡ Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª Ù†Ø§Ù‚ØµØ© ÙˆØ³Ø¨Ø¨Øª Ø§Ù„Ø®Ø·Ø£
  channels      ContactChannel[] // Ù„Ø±Ø¨Ø· Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„
  conversations Conversation[]   // Ù„Ø±Ø¨Ø· Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„
  // ğŸ‘†ğŸ‘†ğŸ‘†

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([phone])
  @@index([email])
  @@unique([tenantId, phone])
  @@unique([tenantId, email])
}

model ContactChannel {
  id         String   @id @default(uuid())
  platform   Platform
  identifier String
  contactId  String
  contact    Contact  @relation(fields: [contactId], references: [id])

  @@unique([platform, identifier, contactId])
}

// ==========================================
// 4. Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„
// ==========================================

model Conversation {
  id            String             @id @default(uuid())
  status        ConversationStatus @default(OPEN)
  channel       Platform
  unreadCount   Int                @default(0)
  lastMessageAt DateTime           @default(now())

  contactId  String
  contact    Contact @relation(fields: [contactId], references: [id])
  assigneeId String?
  assignee   User?   @relation(fields: [assigneeId], references: [id])
  tenantId   String
  tenant     Tenant  @relation(fields: [tenantId], references: [id])

  messages Message[]
}

model Message {
  id             String    @id @default(uuid())
  content        String?
  mediaUrl       String?
  mediaType      String?
  type           MsgType   @default(TEXT)
  direction      MsgDir
  status         MsgStatus @default(SENT)
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  createdAt      DateTime  @default(now())
}

// ==========================================
// 5. Ù…Ù†Ø´Ø¦ Ø§Ù„Ø¨ÙˆØª (Flow Builder)
// ==========================================

model Flow {
  id             String     @id @default(uuid())
  name           String
  isActive       Boolean    @default(true)
  triggerKeyword String?
  tenantId       String
  tenant         Tenant     @relation(fields: [tenantId], references: [id])
  steps          FlowStep[]
}

model FlowStep {
  id       String   @id @default(uuid())
  flowId   String
  flow     Flow     @relation(fields: [flowId], references: [id])
  type     StepType
  content  Json
  position Json?
  
  // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ ---
  parentId String?
  parentStep FlowStep? @relation("NextStep", fields: [parentId], references: [id])
  
  // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† Ù†Ø§Ù‚ØµØ§Ù‹ (Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ø¹ÙƒØ³ÙŠØ©)
  children   FlowStep[] @relation("NextStep")
  // -------------------

  nextSteps           FlowConnection[] @relation("SourceStep")
  incomingConnections FlowConnection[] @relation("TargetStep")
}

model FlowConnection {
  id           String  @id @default(uuid())
  sourceStepId String
  sourceStep   FlowStep @relation("SourceStep", fields: [sourceStepId], references: [id])
  targetStepId String
  targetStep   FlowStep @relation("TargetStep", fields: [targetStepId], references: [id])
  triggerValue String?
}

// ==========================================
// Enums (Ø§Ù„Ø«ÙˆØ§Ø¨Øª - Ù…ØµØ­Ø­Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚)
// ==========================================

enum Role {
  ADMIN
  AGENT
  SUPER_ADMIN
}

enum PlanType {
  STARTER
  GROWTH
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIAL
}

enum AddonType {
  STORAGE_GB
  EXTRA_USER
  EXTRA_CHANNEL
}

enum Platform {
  WHATSAPP
  TELEGRAM
  INSTAGRAM
  TWITTER
  WEB
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum MsgType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  LOCATION
  INTERACTIVE
}

enum MsgDir {
  INCOMING
  OUTGOING
}

enum MsgStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

enum StepType {
  MESSAGE
  MENU
  INPUT
  ACTION_ASSIGN
  ACTION_TAG
}