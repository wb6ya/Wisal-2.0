// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. إدارة الشركات والاشتراكات (Tenants)
// ==========================================

model Tenant {
  id                      String             @id @default(uuid())
  name                    String
  email                   String             @unique
  plan                    PlanType           @default(STARTER)
  subscriptionStatus      SubscriptionStatus @default(ACTIVE)
  subscriptionEndsAt      DateTime?
  maxAgents               Int                @default(2)
  baseStorageLimitMB      Int                @default(1000)
  extraStoragePurchasedMB Int                @default(0)
  mediaRetentionDays      Int                @default(60)
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  whatsappPhoneNumberId   String?            @unique

  // العلاقات العكسية
  users         User[]
  contacts      Contact[]
  flows         Flow[]
  conversations Conversation[]
  addons        SubscriptionAddon[]
}

model SubscriptionAddon {
  id       String    @id @default(uuid())
  type     AddonType
  quantity Int
  cost     Float
  active   Boolean   @default(true)
  tenantId String
  
  // ✅ Cascade: إذا حذفت الشركة، احذف إضافاتها
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// ==========================================
// 2. الموظفين والصلاحيات (Users)
// ==========================================

model User {
  id                    String         @id @default(uuid())
  email                 String         @unique
  password              String
  name                  String
  role                  Role           @default(AGENT)
  isActive              Boolean        @default(true)
  tenantId              String
  
  // ✅ Cascade: إذا حذفت الشركة، احذف موظفيها
  tenant                Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  assignedConversations Conversation[]
}

// ==========================================
// 3. العملاء والقنوات (Contacts)
// ==========================================

model Contact {
  id        String   @id @default(uuid())
  name      String?
  phone     String?
  email     String?
  avatarUrl String?
  tags      String[]
  metadata  Json?

  tenantId  String
  // ✅ Cascade: إذا حذفت الشركة، احذف عملائها
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  channels      ContactChannel[]
  conversations Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, phone]) // لا يجوز تكرار الرقم لنفس الشركة
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([phone])
}

model ContactChannel {
  id         String   @id @default(uuid())
  platform   Platform
  identifier String   // مثل chat_id في تيليقرام أو user_id في انستقرام
  contactId  String
  
  // ✅ Cascade: إذا حذفنا العميل، نحذف قنوات اتصاله
  contact    Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([platform, identifier, contactId])
}

// ==========================================
// 4. المحادثات والرسائل (Conversations)
// ==========================================

model Conversation {
  id            String             @id @default(uuid())
  status        ConversationStatus @default(OPEN)
  channel       Platform
  unreadCount   Int                @default(0)
  lastMessageAt DateTime           @default(now())
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  contactId  String
  // ✅ Cascade: إذا حذفنا العميل، نحذف محادثاته
  contact    Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  assigneeId String?
  assignee   User?   @relation(fields: [assigneeId], references: [id]) // لا نحذف المحادثة إذا حذف الموظف (فقط تصبح بدون موظف)
  
  tenantId   String
  // ✅ Cascade: تنظيف شامل عند حذف الشركة
  tenant     Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  messages   Message[]
}

model Message {
  id             String    @id @default(uuid())
  content        String?   // يمكن أن تكون فارغة إذا كانت صورة فقط
  mediaUrl       String?
  mediaType      String?
  type           MsgType   @default(TEXT)
  direction      MsgDir
  status         MsgStatus @default(SENT)
  
  conversationId String
  // ✅ Cascade: إذا حذفت المحادثة، احذف رسائلها
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime  @default(now())
}

// ==========================================
// 5. منشئ البوت (Flow Builder)
// ==========================================

model Flow {
  id             String     @id @default(uuid())
  name           String
  isActive       Boolean    @default(true)
  triggerKeyword String?
  tenantId       String
  // ✅ Cascade: إذا حذفت الشركة، احذف بوتاتها
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  steps          FlowStep[]
}

model FlowStep {
  id       String   @id @default(uuid())
  flowId   String
  // ✅ Cascade: إذا حذفت البوت، احذف خطواته
  flow     Flow     @relation(fields: [flowId], references: [id], onDelete: Cascade)
  
  type     StepType
  content  Json     // محتوى الرسالة أو السؤال
  position Json?    // إحداثيات X,Y للرسم في الواجهة

  // العلاقة الذاتية (للهيكلة الشجرية البسيطة)
  parentId String?
  parentStep FlowStep? @relation("NextStep", fields: [parentId], references: [id], onDelete: SetNull)
  children   FlowStep[] @relation("NextStep")

  // العلاقات المعقدة (للهيكلة الشبكية Graph)
  nextSteps           FlowConnection[] @relation("SourceStep")
  incomingConnections FlowConnection[] @relation("TargetStep")
}

model FlowConnection {
  id           String   @id @default(uuid())
  
  sourceStepId String
  // ✅ Cascade: إذا حذفت الخطوة، احذف الوصلة الخارجة منها
  sourceStep   FlowStep @relation("SourceStep", fields: [sourceStepId], references: [id], onDelete: Cascade)
  
  targetStepId String
  // ✅ Cascade: إذا حذفت الخطوة، احذف الوصلة الداخلة إليها
  targetStep   FlowStep @relation("TargetStep", fields: [targetStepId], references: [id], onDelete: Cascade)
  
  triggerValue String? // الكلمة أو الزر الذي ينقلنا لهذه الخطوة
}

// ==========================================
// Enums
// ==========================================

enum Role {
  ADMIN
  AGENT
  SUPER_ADMIN
}

enum PlanType {
  STARTER
  GROWTH
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIAL
}

enum AddonType {
  STORAGE_GB
  EXTRA_USER
  EXTRA_CHANNEL
}

enum Platform {
  WHATSAPP
  TELEGRAM
  INSTAGRAM
  TWITTER
  WEB
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum MsgType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  LOCATION
  INTERACTIVE
}

enum MsgDir {
  INCOMING
  OUTGOING
}

enum MsgStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

enum StepType {
  MESSAGE
  MENU
  INPUT
  ACTION_ASSIGN
  ACTION_TAG
}